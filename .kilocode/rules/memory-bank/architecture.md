# Архитектурные правила MyIS (memory bank)

Этот файл даёт сжатый, но полный набор архитектурных норм для ИИ. Подробная нормативка — в `.kilocode/rules/Coding_Guidelines_MyIS.md` и `.kilocode/rules/MyIS_Architecture_Core_Requirements.md`.

## 1. Слои и их обязанности

Система построена по слоистой архитектуре:

- **Domain (MyIS.Core.Domain)**  
  - Что содержит: Entities, Value Objects, Domain Services, доменные события.  
  - Разрешено:
    - инварианты и предметная логика;
    - статусы и workflow через типизированные статусы и VO.
  - Запрещено:
    - любые зависимости от EF, SQL, HTTP, файлов;
    - DTO, ViewModel, API‑модели;
    - логирование.

- **Application (MyIS.Core.Application)**  
  - Что содержит: Use Cases (Handlers), DTO (Commands/Queries/Responses), интерфейсы репозиториев и сервисов, AccessChecker.  
  - Разрешено:
    - получение DTO от WebApi;
    - загрузка сущностей через репозитории;
    - вызов доменной логики;
    - изменение состояния системы через Use Case;
    - проверка прав через AccessChecker.
  - Запрещено:
    - прямой доступ к БД;
    - дублирование доменной логики;
    - завязка на конкретные инфраструктурные технологии.

- **Infrastructure (MyIS.Core.Infrastructure)**  
  - Что содержит: реализацию репозиториев, EF Core DbContext и миграции, интеграции (включая Integration.Component2020).  
  - Разрешено:
    - конфигурации EF Core, маппинг доменных сущностей в таблицы;
    - реализация интерфейсов Application (репозитории, внешние сервисы);
    - доступ к внешним системам (Компонент‑2020, файловые хранилища, SMTP и т.п.).
  - Запрещено:
    - бизнес‑логика;
    - прямое изменение доменных сущностей вне сценариев, определённых Application.

- **WebApi (MyIS.Core.WebApi)**  
  - Что содержит: контроллеры и точки входа HTTP.  
  - Разрешено:
    - маппинг HTTP ↔ DTO;
    - вызов Use Case из Application;
    - базовая валидация и маппинг ошибок в HTTP‑коды.
  - Запрещено:
    - доменная логика (статусы, workflow, расчёты);
    - прямое изменение доменных сущностей или обращение к БД.

- **Frontend**  
  - Что содержит: React SPA, App Shell, модули по доменам, API‑клиенты.  
  - Разрешено:
    - UI‑логика, валидация ввода, представление данных;
    - RBAC через абстракции вида `can(permission)` (будущая модель прав);
    - строго типизированные клиенты к REST API.
  - Запрещено:
    - бизнес‑логика домена;
    - проверка ролей напрямую через массивы ролей без слоя прав.

## 2. Доменные модули и границы

Домены (Requests, Customers, Engineering, Technology, Production, Procurement, Warehouse, Integration.Component2020) описаны в Doc/00_Концепция_системы.md.

Ключевые принципы (см. также `.kilocode/rules/MyIS_Architecture_Core_Requirements.md`):

- у каждой доменной сущности есть один «домашний» модуль, который отвечает за создание и изменение этой сущности;
- другие модули могут:
  - либо читать упрощённые представления (DTO проекций),
  - либо запрашивать изменения через явно определённые Use Case;
- прямой доступ к таблицам других доменов (даже в одной БД) считается нарушением архитектуры.

ИИ не должен:

- вводить репозитории, которые читают «чужие» таблицы напрямую;
- пробрасывать внутренние сущности одного модуля наружу без DTO/контрактов Application.

## 3. Идентификаторы, Value Objects и workflow

Согласно `.kilocode/rules/MyIS_Architecture_Core_Requirements.md`:

- все идентификаторы — GUID или специализированные ID‑VO;
- обязательные Value Objects:
  - Quantity;
  - Money;
  - DateRange;
  - Status;
  - Version;
- статусы типизированы (enum или VO), переходы управляются доменной логикой.

Для модуля Requests (см. Doc/20_ТЗ_Этап1_Requests.md) базовая схема статусов заявки:

- Черновик;
- На согласовании;
- Согласована;
- В работе;
- Закрыта;
- Отклонена.

Требования:

- допустимые переходы между статусами определяются доменной логикой и/или конфигурацией;
- история статусов и действий пользователей должна фиксироваться как отдельная сущность (аудит статусов).

## 4. Use Case и паттерн запросов

Модель Use Case (Application layer) — норматив:

- вход: DTO (Command или Query);
- обработчик: Handler (например, `CreateSomethingHandler`);
- работа:
  - загрузка доменных сущностей через репозитории;
  - вызов методов доменных сущностей и доменных сервисов;
  - фиксация изменений через Unit of Work / DbContext;
- выход: DTO (Response).

Шаблон взаимодействия:

- WebApi Controller:
  - принимает HTTP‑запрос;
  - маппит в Command/Query DTO;
  - вызывает соответствующий Handler;
  - маппит результат в HTTP‑ответ.
- Application:
  - реализует Handler, не знает о HTTP и UI;
  - опирается только на интерфейсы репозиториев и сервисов.
- Infrastructure:
  - даёт реализации репозиториев и внешних сервисов, но не расширяет их предметной логикой.

AccessChecker:

- единственное место для проверки прав в Application;
- не должен дублировать бизнес‑правила домена, только решать, кому какие Use Case доступны.

## 5. Интеграции и внешние системы

Компонент‑2020 и другие внешние системы:

- считаются «внешним миром» относительно доменных модулей;
- доступны только через Infrastructure и модуль интеграции (например, Integration.Component2020).

Правила:

- Domain и Application не должны содержать прямого кода для доступа к Компонент‑2020;
- Infrastructure отвечает за:
  - адаптацию внешних структур данных к внутренним DTO/моделям;
  - надёжность, обработку ошибок и логирование интеграций.

При проектировании новых интеграций ИИ должен:

- добавлять интерфейсы в Application;
- реализовывать их в Infrastructure;
- учитывать архитектурные требования к аудиту, обработке ошибок и схемам БД (включая использование отдельных схем по доменам).
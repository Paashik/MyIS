# Технологический контекст MyIS

Этот файл даёт ИИ минимально достаточное понимание стека, окружения и типовых технических сценариев.

## 1. Backend

Технологический стек:

- .NET 8, C#;
- ASP.NET Core Web API;
- PostgreSQL;
- Npgsql;
- EF Core 8;
- модульный монолит (общая БД, слоистая архитектура, доменные модули).

Проекты (по структуре из [`14_Приложение_Е_Структура_репозитория_Git_Этап0.md`](Doc/14_Приложение_Е_Структура_репозитория_Git_Этап0.md)):

- `backend/src/Core.Domain` — доменные модели и правила;
- `backend/src/Core.Application` — Use Case, DTO, интерфейсы;
- `backend/src/Core.Infrastructure` — DbContext, миграции, репозитории, интеграции;
- `backend/src/Core.WebApi` — API и точка входа.

Схема БД для Этапа 0:

- основная схема: `core`;
- ключевые таблицы (по [`12_Приложение_Г_Модель_данных_users_roles_Этап0.md`](Doc/12_Приложение_Г_Модель_данных_users_roles_Этап0.md)):
  - `core.users` (пользователи, UUID‑id, login, password_hash, full_name, is_active, audit‑поля);
  - `core.roles` (роли, UUID‑id, code, name, audit‑поля);
  - `core.user_roles` (связь многие‑ко‑многим, составной ключ user_id + role_id, assigned_at).

Миграции:

- EF Core Migrations в `Core.Infrastructure/Migrations`;
- миграция инициализации и сидирования администратора создаёт расширение `uuid-ossp`, схему `core`, таблицы и seed:
  - роль ADMIN с фиксированным GUID;
  - пользователя Admin с фиксированным GUID и bcrypt‑хэшем пароля `admin`;
  - связь user_roles между ними.

## 2. Подключение к БД и Admin DB API

Подключение к PostgreSQL и диагностика реализованы через:

- `IConnectionStringProvider` и `DefaultConnectionStringProvider` — получение строки подключения с приоритетом:
  - `appsettings.Local.json` (секция `ConnectionStrings:Default`),
  - затем стандартные источники конфигурации (appsettings, environment и т.п.);
- `DbConnectionStatus` — DTO для результата проверки подключения;
- `IDbHealthService` / `DbHealthService` — сервис проверки доступности БД:
  - не бросает исключений наружу, возвращает детализированный статус (`Configured`, `CanConnect`, `LastError`, `Environment`, источник строки).

`AppDbContext`:

- ставит схему `core` по умолчанию;
- применяет конфигурации из сборки `Core.Infrastructure`.

Регистрация в `Program.cs`:

- добавление `appsettings.Local.json` с `reloadOnChange`;
- регистрация `IConnectionStringProvider`, `IDbHealthService`, `AppDbContext` с ленивой конфигурацией (если строка не настроена — контекст не конфигурируется, но приложение стартует).

Admin DB API (`Core.WebApi`, контроллер AdminDbController):

- `GET /api/admin/db-status` — возвращает `DbConnectionStatus` (настройка и доступность БД);
- `POST /api/admin/db-config/test` — принимает параметры подключения, собирает временную строку, проверяет соединение к PostgreSQL, возвращает результат проверки и безопасное представление строки;
- `POST /api/admin/db-config/apply` (только в окружении Development):
  - сохраняет строку подключения в `appsettings.Local.json`;
  - проверяет соединение;
  - вызывает EF‑миграции к новой БД;
  - возвращает флаги: применена ли строка, применены ли миграции, текст последней ошибки.

## 3. Аутентификация и модель безопасности Этапа 0

На Этапе 0 реализована базовая схема аутентификации и авторизации (см. [`12_Приложение_Г_Модель_данных_users_roles_Этап0.md`](Doc/12_Приложение_Г_Модель_данных_users_roles_Этап0.md) и [`13_Приложение_Д_API_Login_Auth_Этап0.md`](Doc/13_Приложение_Д_API_Login_Auth_Этап0.md)):

- хранилище пользователей и ролей в схеме `core`;
- пароль хранится только как bcrypt‑хэш;
- seed администратора (Admin/admin, роль ADMIN) через EF‑миграцию.

Сервис аутентификации:

- интерфейс `IAuthService` в Application;
- реализация `AuthService` в Infrastructure:
  - ищет пользователя по логину;
  - проверяет флаг активности;
  - сравнивает пароль с bcrypt‑хэшем (`IPasswordHasher`);
  - собирает набор кодов ролей (`Role.Code`) через связку user_roles.

API Login/Auth:

- `POST /api/auth/login`:
  - вход: JSON `{ "login": "...", "password": "..." }`;
  - при успехе: данные пользователя (id, login, fullName, roles), установка аутентификационного cookie `.MyIS.Auth`;
  - при ошибке:
    - 401 — неверные логин/пароль;
    - 403 — заблокированный пользователь.
- `POST /api/auth/logout`:
  - завершает сессию, сбрасывает cookie, возвращает 200.
- `GET /api/auth/me`:
  - при действующей сессии: возвращает данные текущего пользователя;
  - при отсутствии: 401.

На backend настроена cookie‑аутентификация с именем cookie `.MyIS.Auth`, временем жизни и обработчиками редиректов, которые в случае SPA возвращают 401/403 вместо реального редиректа (см. Program.cs).

## 4. Frontend и каркас UI

Фронтенд (см. [`11_Приложение_В_Каркас_интерфейса_Этап0.md`](Doc/11_Приложение_В_Каркас_интерфейса_Этап0.md) и [`Описание состояния после Этап 0.md`](Doc/Описание состояния после Этап 0.md)):

- React 18;
- TypeScript 5;
- Vite;
- Ant Design 5;
- React Router v6.

Дополнительно (норматив для UI и тестов):

- язык интерфейса по умолчанию — **RU (ru-RU)**;
- автотесты UI должны опираться на устойчивые селекторы (`data-testid`/`role`/`aria-*`/имена полей/URL), а не на отображаемые тексты;
- рекомендуемый базовый паттерн i18n (RU-словарь + `t(key)`), а также требования к «антихрупким» тестам — см. `6` в [`guidelines.md`](.kilocode/rules/memory-bank/guidelines.md).

Структура:

- App Shell на основе Ant Design Layout:
  - Header — название системы, пользователь, меню профиля;
  - Sider — навигация по доменам (Requests, Customers, Procurement, Production, Warehouse, Engineering, Technology);
  - Content — рабочая область для страниц модулей.
- публичные маршруты:
  - `/login` — страница входа (форма логина/пароля, обработка ошибок);
  - `/db-setup` — мастер настройки БД (форма параметров подключения, проверка, применение);
- приватные маршруты:
  - обёртка `DbStatusGuard`:
    - вызывает `/api/admin/db-status`;
    - при не настроенной/недоступной БД перенаправляет на `/db-setup`;
  - обёртка `RequireAuth`:
    - при отсутствии пользователя в контексте вызывает `/api/auth/me`;
    - восстанавливает пользователя или перенаправляет на `/login`;
  - внутри — App Shell и доменные страницы (`/`, `/requests`, `/customers` и т.д.).

AuthContext:

- хранит информацию о текущем пользователе и его ролях;
- предоставляет методы `login`, `logout`, `refreshMe`;
- используется UI для условного отображения контента (в будущем — c учётом RBAC).

## 5. Dev‑процесс, структура репозитория и CI/CD

Структура репозитория (по [`14_Приложение_Е_Структура_репозитория_Git_Этап0.md`](Doc/14_Приложение_Е_Структура_репозитория_Git_Этап0.md), адаптирована под текущий проект):

- корень:
  - `backend/` — .NET решение с проектами Core.Domain/Application/Infrastructure/WebApi;
  - `frontend/` — React SPA на Vite;
  - `Doc/` — документация (концепция, ТЗ по этапам и приложения);
  - `.kilocode/` — правила для ИИ и memory bank;
  - вспомогательные файлы (`DEV_SETUP.md`, `dev.cmd`, `.gitignore` и т.п.).

Минимальный сценарий развёртывания dev‑стенда (см. [`Описание состояния после Этап 0.md`](Doc/Описание состояния после Этап 0.md)):

1. Клонировать репозиторий.
2. Установить зависимости фронтенда (`npm install` в `frontend`).
3. Применить миграции БД (через `dotnet ef database update` или через Admin DB API).
4. Запустить `dev.cmd`:
   - `dotnet watch run` для backend;
   - `npm run dev` для фронта.

Требования к CI/CD (по [`15_Приложение_Ж_Требования_CI_CD_Этап0.md`](Doc/15_Приложение_Ж_Требования_CI_CD_Этап0.md)):

- CI:
  - запуск на push и merge request в основные ветки;
  - шаги: checkout, сборка backend, запуск тестов, сборка frontend, статический анализ (опционально);
- CD:
  - минимум две среды: dev/test и prod;
  - деплой из артефактов сборки:
    - `dotnet publish` для backend;
    - собранный frontend (статические файлы);
  - применение миграций БД при деплое;
  - понятная процедура отката и наличие бэкапов.

ИИ при генерации DevOps‑сценариев должен опираться на эти принципы и не придумывать произвольные структуры, конфликтующие с существующим репозиторием.

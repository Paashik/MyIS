# 6. Ключевые бизнес-процессы вокруг заявок (целевое видение)

Ниже — целевые схемы «как должно быть». Детализация до шагов/ролей может быть вынесена в отдельные BPM-диаграммы.

## 6.1. Сквозной процесс "Заявка -> Разработка -> Производство -> Отгрузка"

Процесс работает в двух режимах:

* Разработка + производство.
* Только производство (изделие уже освоено).

Различие только в шагах разработки, далее процесс унифицируется.

**Роли:** инициатор заявки (менеджер, руководитель, заказчик), руководитель подразделения, инженер/конструктор, технолог, снабжение, производство, склад, контроль/диспетчер, головное предприятие (финансы, закупка, отгрузка).

### Этап 1. Поступление заявки

**Окно:** `Requests -> Создать заявку`

**Тип заявки:**

* Заявка на разработку и производство изделия.
* Заявка на производство изделия.

**Поля:** заказчик (внутренний/внешний), основание (договор/письмо/устно), изделие (если известно) или описание, количество, требуемые сроки, комментарий.

**Действия:** сохранить как черновик; отправить на согласование.

**Окно:** `Requests -> Согласование`

**Действия согласующих:** согласовать; вернуть на доработку; отклонить.

**Выходы:** заявка получает статус **Согласована** и предлагает следующий шаг: **Создать заказ клиента** / **Создать внутренний заказ на производство**.

### Этап 2. Заказ клиента (логический, не бухгалтерский)

**Окно:** `Customers -> Заказ клиента` (создается автоматически или вручную из заявки).

**Содержит:** заказчика, изделие (Item), количество, сроки, привязку к заявке.

**Действия:** подтвердить заказ; отменить; перейти к обеспечению.

### Этап 3. Разработка (только если изделие новое или измененное)

**Окно:** `Items -> Карточка изделия`

Если изделие новое, создается `Item` с минимальным набором: номенклатурный номер, обозначение (если есть), наименование, статус **В разработке**.

**Вкладка "Инженерная":** прикрепление КД, ведение ревизий, действие **Передать в технологию**.

**Вкладка "Технологическая":** маршруты, операции, внешние техпроцессы; действия **Сформировать технологию**, **Разрешить в производство**.

### Этап 4. Подготовка производства и обеспечение

**Окно:** `Requests -> Заявки на обеспечение / внешний техпроцесс`

Создаются заявки на закупку материалов/комплектующих и заявки на внешние операции (платы, гальваника, покраска).

**Действия:** выбор маршрута (через головное предприятие / прямая закупка), согласование, формирование заказов поставщикам.

### Этап 5. Производственный заказ

**Окно:** `Production -> Производственный заказ`

Создается на основании заказа клиента, согласованной технологии и обеспеченных материалов.

**Статусы:** **Запланирован** -> **В работе** -> **Готов к приемке** -> **Завершен**.

### Этап 6. Диспетчеризация и контроль

**Окно:** `Production -> Диспетчер`

Отображает все активные заказы, отклонения по срокам, блокировки (нет материалов/нет внешних работ).

**Действия:** остановить; возобновить; создать заявку (доп. обеспечение/изменение).

### Этап 7. Приемка и склад

**Окно:** `Warehouse -> Приход`

**Действия:** принять готовую продукцию, указать количество, документы, привязку к заказу.

**Выход:** изделие доступно для отгрузки.

### Этап 8. Отгрузка

**Окно:** `Warehouse -> Отгрузка`

**Основание:** заказ клиента.

**Действия:** подготовить отгрузку; зафиксировать отгрузку; указать количество, дату, документы.

### Этап 9. Закрытие цикла

Автоматически закрываются производственный заказ и заказ клиента, исходная заявка получает статус **Закрыта**.

**Принципы процесса и UI:**

* Нет "магических переходов": каждый шаг - заявка, заказ или статус.
* `Requests` - управляющий контур: через заявки можно остановить, изменить или дообеспечить процесс.
* `Item` - центр всего: изделие не дублируется между модулями.
* UI строится одинаково: **Журнал -> Карточка -> Действия**.

## 6.2. Заявка на разработку / разработку+изготовление

**Цель:** получить управляемый процесс от входящего запроса до принятия решения и запуска работ (заказа клиента и связанных внутренних заказов/заявок).

Кратко:

1. Поступает заявка (от головного / внешнего заказчика).
2. Инициатор регистрирует ее в модуле `Requests`.
3. Статусы и действия:

   * **Черновик** -> **На согласовании** (Submit);
   * **На согласовании** -> **На рассмотрении** (StartReview);
   * **На рассмотрении** -> **Согласована** (Approve) или **Отклонена** (Reject);
   * **Согласована** -> **В работе** (StartWork);
   * **В работе** -> **Выполнена** (Complete) -> **Закрыта** (Close).

4. При согласовании:

   * модуль `Customers` создает **заказ клиента на разработку**;
   * модуль `Engineering`:

     * резервирует или создает новую позицию изделия;
     * планирует ревизию/спецификацию.
5. По завершении работ (разработка/изготовление/поставка) заявка закрывается.

## 6.3. Заявка на изготовление изделий

**Цель:** управляемо запустить производство по уже определенному изделию/ревизии.

Кратко:

1. Инициатор (головное или внешнее лицо через менеджера) оформляет запрос на изготовление.
2. Заявка регистрируется (с указанием изделия, объема, сроков).
3. Согласование включает:

   * проверку загрузки производства;
   * проверку доступности комплектующих (через `Warehouse` и/или `Procurement`).

4. При согласовании:

   * в модуле `Production` создается **производственный заказ и партии**;
   * заявка связывается с соответствующим заказом клиента.

5. Статусы и действия:

   * **Черновик** -> **На согласовании** (Submit) -> **На рассмотрении** (StartReview);
   * **Согласована** (Approve) -> **В работе** (StartWork) -> **Выполнена** (Complete) -> **Закрыта** (Close);
   * **Отклонена** (Reject) завершает процесс.

## 6.4. Заявка на закупку под заказ клиента

**Цель:** обеспечить прозрачный цикл "потребность -> согласование -> выбор маршрута закупки -> заказы поставщикам -> приход на склад" с сохранением информации о том, что, где, когда и по какой цене закупалось.

1. На основании заказа клиента (из Компонента или модуля `Customers`) создается **Заявка на обеспечение / закупку** в `Requests`:

   * перечень нужных комплектующих/материалов/услуг;
   * привязка к заказу клиента/изделию/партии;
   * предварительно выбираются адресат и маршрут закупки (через головное предприятие или прямая закупка подразделением).

2. На этапе согласования заявки:

   * уточняется состав и количества;
   * проверяются складские остатки/резервы (`Warehouse`);
   * принимается решение по маршруту закупки (оставить через головное предприятие или разрешить прямую закупку подразделением);
   * при необходимости инициируется согласование условий закупки с головным предприятием.

3. Статусы и действия: **Черновик** -> **На согласовании** -> **На рассмотрении** -> **Согласована** -> **В работе** -> **Выполнена** -> **Закрыта**.

Дальнейшая цепочка зависит от выбранного маршрута закупки.

**Сценарий 1. Закупка через головное предприятие**

4. Согласованная заявка с маршрутом "через головное предприятие" передается в модуль `Procurement` и далее - в головное предприятие (через `Integration.Component2020` или другой согласованный канал). Детализированная структура доступов Компонент-2020, задействованная в интеграции, приведена в [Component2020_Access_schema_mermaid.md](../.kilocode/rules/Component2020_Access_schema_mermaid.md).

5. Головное предприятие:

   * запрашивает и получает коммерческие предложения/счета у внешних поставщиков;
   * заключает договоры и оплачивает счета;
   * возвращает в подразделение информацию о выбранных поставщиках, ценах и условиях (копии КП/счетов).

6. В `Procurement` на основании полученной информации создаются **заказы поставщикам** на реальных контрагентов с признаком маршрута "через головное предприятие" и плательщиком "головное предприятие". Заявка на обеспечение связывается с соответствующими заказами поставщикам.

7. При поступлении комплектующих/материалов:

   * в `Warehouse` оформляется приход на склад с привязкой к заказу поставщику и исходной заявке;
   * первичные документы (накладные, УПД и т.п.), если они попадают в подразделение, регистрируются в системе по реквизитам и передаются в головное предприятие для бухгалтерской обработки;
   * статусы заявок и заказов поставщикам обновляются.

**Сценарий 2. Прямая закупка подразделением**

4'. Согласованная заявка с маршрутом "прямая закупка" обрабатывается в `Procurement` как инициатива на прямой контакт с поставщиками от имени подразделения.

5'. `Procurement`:

* запрашивает коммерческие предложения и/или счета у внешних поставщиков;
* при необходимости инициирует согласование условий закупки с головным предприятием (например, через внешний BPM-процесс);
* по результатам согласования выбирает поставщиков по позициям.

6'. На основании согласованных счетов в `Procurement` создаются **заказы поставщикам**:

* с реальными поставщиками;
* с признаком маршрута "прямая закупка подразделением" и плательщиком "головное предприятие";
* с привязкой к исходной заявке на обеспечение и заказу клиента/партии.

7'. При поступлении комплектующих/материалов:

* подразделение получает товар и первичные документы (накладные, УПД, акты);
* в `Warehouse` оформляется приход на склад с указанием реквизитов первичных документов и связью с заказом поставщику;
* сами первичные документы передаются в головное предприятие для оплаты и бухгалтерского учета;
* статусы заявок и заказов поставщикам обновляются до "исполнено/закрыто".

## 6.5. Диспетчеризация и контроль исполнения

**Цель:** обеспечить актуальное представление статусов и оперативный контроль исполнения заявок, заказов, закупок и производственных задач.

Кратко:

1. Модуль `Requests` собирает и отображает сводные статусы по цепочке «заявка → заказ клиента → закупка → производство → склад».
2. Модуль `Production` предоставляет информацию о ходе выполнения производственных заказов и партий (план/факт, текущая стадия, отклонения по срокам).
3. Модуль `Procurement` предоставляет статусы по заказам поставщикам и ожидаемым поставкам.
4. Модуль `Warehouse` предоставляет данные по фактическим остаткам, резервам и ключевым движениям.
5. На основе этих данных диспетчер/руководитель может:

   * выявлять просроченные и рисковые объекты (заявки, заказы, партии);
   * менять приоритеты и перераспределять ресурсы;
   * инициировать корректирующие действия (дополнительные заявки, перенос сроков, перераспределение заказов между контрагентами и т.п.).

## 6.6. Процесс разработки и постановки изделия на производство

**Цель:** обеспечить управляемый и прослеживаемый переход изделия от стадии идеи/разработки до освоенного мелкосерийного производства без введения отдельной сущности «проект» в Системе.

Процесс рассматривается как последовательность стадий жизненного цикла изделия и технологии, реализуемых через существующие объекты Системы:

* заявки (заявка заказчика, заявки на изменение, внутренние производственные заявки, заявки на внешний технологический этап, заявки на обеспечение/закупку);
* заказы клиентов и производственные заказы;
* изделия и их ревизии в домене `Engineering`;
* маршруты и техпроцессы в домене `Technology`.

### 6.6.1. Стадии жизненного цикла изделия и технологии

Для каждой ревизии изделия в `Engineering` и связанного маршрута в `Technology` в Системе фиксируются стадии готовности, например:

* для изделия:

  * «Разработка»;
  * «Опытные образцы»;
  * «Опытная партия / отработка технологии»;
  * «Освоенное мелкосерийное производство»;

* для техпроцесса:

  * «Черновой маршрут»;
  * «Маршрут для опытных образцов»;
  * «Маршрут для опытной партии»;
  * «Утверждённый маршрут для мелкосерийки».

Переход между стадиями осуществляется по результатам выполнения связанных работ и оформляется ответственными лицами (конструктор, технолог, руководитель).

### 6.6.2. Основные этапы процесса (сквозной сценарий)

1. **Инициация разработки**

   * Поступает Заявка заказчика (на разработку или разработку+изготовление).
   * В `Customers` создаётся соответствующий заказ клиента.
   * В `Engineering` заводится изделие/ревизия со стадией «Разработка».

2. **Разработка и уточнение требований**

   * В `Engineering` выполняется разработка КД, формирование первоначальной спецификации (BOM).
   * При необходимости оформляются Заявки на изменение (уточнение требований, замена компонентов и т.п.).
   * Стадия изделия остаётся «Разработка».

3. **Опытные образцы**

   * Оформляется Внутренняя производственная заявка на изготовление опытных образцов.
   * Создаётся производственный заказ в `Production`, при необходимости — Заявки на внешний технологический этап (платы, детали, покрытия) и Заявки на обеспечение/закупку.
   * По результатам испытаний изделий и анализа проблем могут подаваться дополнительные Заявки на изменение.
   * После успешных испытаний стадия изделия переводится в «Опытные образцы».

4. **Опытная партия / отработка технологии**

   * Оформляется новая Внутренняя производственная заявка на опытную/установочную партию (например, 10–50 шт.).
   * В `Technology` уточняется маршрут и нормы, при необходимости в него вносятся изменения через Заявки на изменение.
   * В `Production` выполняется партия с контролем по ключевым параметрам (качество, трудоёмкость, узкие места).
   * По результатам отработки технологии принимается решение о готовности к мелкосерийному производству, стадия изделия меняется на «Опытная партия / отработка технологии» или «Освоенное мелкосерийное производство».

5. **Постановка на мелкосерийное производство**

   * Маршрут и техдокументация в `Technology` переводятся в статус «Утверждённый маршрут для мелкосерийки».
   * Изделие в `Engineering` переводится в стадию «Освоенное мелкосерийное производство».
   * Дальнейшие заказы клиентов по данному изделию обрабатываются как обычные заказы с использованием утверждённых КД/ТД, при этом изменения вносятся только через Заявки на изменение.

### 6.6.3. Роль заявок и диспетчеризации

На всём протяжении процесса разработки и постановки изделия используются стандартные типы заявок:

* Заявка заказчика — инициирует работы по новому изделию;
* Заявки на изменение — фиксируют и контролируют изменения КД/ТД, состава изделия и маршрутов;
* Внутренние производственные заявки — оформляют изготовление опытных образцов и опытных партий;
* Заявки на внешний технологический этап — обеспечивают взаимодействие с контрагентами по платам, деталям, покрытиям и другим внешним операциям;
* Заявки на обеспечение/закупку — закрывают потребность в материалах, комплектующих и оснастке.

Модуль `Requests` и средства диспетчеризации обеспечивают:

* сквозную видимость статусов заявок и связанных с ними заказов по конкретному изделию/ревизии;
* контроль ключевых вех (получение опытных образцов, завершение опытной партии, изменение стадии изделия);
* возможность оперативно выявлять узкие места (задержки по КД, поставкам, внешним техэтапам, производственным заказам).

Такое представление позволяет явно описать процесс разработки и постановки изделия на производство в терминах Системы, использовать существующие сущности (заявки, заказы, изделия, маршруты) без введения отдельной сущности «проект» и сохранить возможность в будущем добавить интеграцию с внешними проектными методиками, если это потребуется.

## 6.7. Планирование производства и загрузки

**Цель:** обеспечить реалистичный и управляемый план запуска и выполнения производственных заказов с учётом ограниченной мощности подразделения, доступности материалов и сроков по заказам клиентов.

Кратко:

1. На основе заказов клиентов (`Customers`), внутренних производственных заявок (`Requests`) и потребности на пополнение склада формируется перечень требуемых производственных заказов.
2. Для каждого изделия/ревизии используются маршруты и нормы времени из `Technology` для оценки трудоёмкости по операциям и участкам.
3. В модуле `Production` создаются/уточняются производственные заказы и партии, им назначаются плановые даты запуска и завершения, при необходимости — приоритет.
4. Система рассчитывает укрупнённую загрузку ключевых участков/оборудования по интервалам (день/неделя) и подсвечивает перегрузки.
5. Диспетчер/руководитель корректирует план (переносит даты, меняет размер партий, маршруты, приоритеты) с учётом:

   * доступности материалов и комплектующих (`Warehouse`, `Procurement`);
   * обязательных сроков по заказам клиентов;
   * ограничений по людям и оборудованию.
6. В ходе исполнения:

   * статусы производственных заказов и партий обновляются в `Production`;
   * план-факт по срокам и загрузке отображается на экранах диспетчеризации.















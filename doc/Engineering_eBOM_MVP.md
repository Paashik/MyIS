# Engineering (eBOM) + Номенклатура (MDM) — как показывать изделия и структуру “из инженерного модуля”, без захода в справочник

Документ фиксирует текущее состояние реализации **MDM (Номенклатура)** и **Engineering/eBOM** в MyIS и описывает, как организовать UX: *в инженерном модуле открыть дерево всех изделий/сборок, их структуру и перечни*, не требуя предварительного выбора в MDM.

## 1) Главная идея (UX)

Пользователь заходит в **Engineering → eBOM** и видит:

1) **Список изделий** (products) — “точки входа” в eBOM (корневые изделия/сборки).  
2) При выборе изделия — **версии BOM** (v1, v2, …).  
3) При выборе версии — **дерево структуры** (подсборки) и **перечень строк** узла (components/materials).  
4) Дополнительно: “взрыв” спецификации (**полный состав сборки/подсборок**) — плоский список всех строк со сквозным количеством.

Таким образом, в Engineering модуле есть собственный “каталог изделий для eBOM”, который *ссылается на MDM Item*, но не требует открывать отдельный справочник MDM.

---

## 2) Связь Engineering и MDM (как устроено сейчас)

### 2.1. MDM Item — единая номенклатура
MDM хранит сущность `Item` (номенклатурная позиция: компонент/материал/изделие/услуга), типизированную через `ItemKind`. MDM считается “источником правды” по мастер-данным.

### 2.2. Engineering Product — “изделие как объект инженерного контура”
В текущей реализации eBOM **корень дерева** определяется как:
- `BomVersion.ProductId` → `Product`
- `Product.ItemId` → `mdm.Item.Id`

То есть eBOM дерево строится по `ItemId` (MDM), но входная точка — именно Engineering `Product`.

---

## 3) Данные eBOM (сущности / поля, важные для дерева и “взрыва”)

### 3.1. Версия спецификации
`BomVersion` — версия BOM для изделия (`ProductId`, `VersionCode`, `Status`, `Source`).  
Рекомендуемый смысл: разные версии eBOM по одному изделию.

### 3.2. Строка спецификации
`BomLine` — строка BOM, ключевые поля:
- `BomVersionId`
- `ParentItemId` — “узел”, к которому относится строка (MDM Item Id)
- `ItemId` — “что входит” (MDM Item Id)
- `Role` (`Component|Material|SubAssembly|Service`)
- `Quantity`, `UnitOfMeasure`, `PositionNo`, `Notes`, `Status`

Таким образом, и **узлы дерева**, и **элементы в составе** представлены через `mdm.items.id`.

---

## 4) Backend API (текущее состояние, важное для UI)

### 4.1. Engineering/eBOM API
Базовые операции eBOM:

- Список изделий (входные точки):
  - `GET /api/engineering/ebom/products?search=&type=&pageNumber=&pageSize=`
- Список версий BOM по изделию (по `itemId`):
  - `GET /api/engineering/ebom/versions?itemId=...`
- Получить одну версию:
  - `GET /api/engineering/ebom/versions/{bomVersionId}`
- Дерево структуры (узлы):
  - `GET /api/engineering/ebom/{bomVersionId}/tree?includeLeaves=false&q=`
  - Поведение:
    - по умолчанию `includeLeaves=false` — “сборочное дерево” (показываем только узлы, у которых есть дети), чтобы дерево не превращалось в полный список компонентов;
    - при поиске `q` листовые узлы включаются, чтобы поиск по компонентам был полезен;
    - есть лимиты/защита от циклов.
- Строки узла (таблица состава выбранного узла дерева):
  - `GET /api/engineering/ebom/{bomVersionId}/lines?parentItemId=...&onlyErrors=false`
  - Важно: строки **не теряются**, даже если `mdm.Item` отсутствует: возвращаются заглушки `N/A` и `[Item {guid}]`.
- “Взрыв” спецификации (полный состав сборки/подсборок):
  - `GET /api/engineering/ebom/{bomVersionId}/explosion?maxDepth=64&maxRows=20000`
  - Возвращает плоский список строк с:
    - `qty` (количество на уровне строки),
    - `totalQty` (сквозное количество = произведение количеств по пути),
    - `level` и `path` (для сортировки/группировки/отладки),
    - заглушки по item, если MDM item отсутствует.

### 4.2. MDM API, нужный Engineering UI (поиск/lookup)
Для Engineering UI важны легковесные endpoint’ы:
- `GET /api/mdm/items/search?q=&take=...`
- `GET /api/mdm/items/lookup/{id}`

Это позволяет:
- искать номенклатуру для добавления строки BOM из формы eBOM,
- отображать “шапку” item (code/name/type), не подтягивая тяжелые справочники.

---

## 5) Как реализовать “дерево всех изделий” в Engineering без выбора в MDM

### 5.1. Логика навигации (рекомендуемый UX-паттерн)
Внутри Engineering/eBOM UI держим собственную навигацию:

**(A) Products → (B) Versions → (C) Tree + Lines (+ Explosion)**

- Products — это фактически “журнал изделий, которые участвуют в инженерной работе”.
- Выбор в MDM не нужен, потому что `Product` уже содержит ссылку на `ItemId`.

### 5.2. Что считать “всеми изделиями”
Практическое определение:
- “все изделия” = все `Product`, которые заведены в Engineering (и связаны с `mdm.Item` через `Product.ItemId`).

Это нормально, потому что Engineering должен показывать именно “инженерно-значимые” изделия, а не всю номенклатуру (компоненты/материалы/услуги).

### 5.3. Структура и перечни “без выбора в MDM”
- **Структура** = дерево по связям `ParentItemId -> ItemId` (узлы/подсборки).
- **Перечень (состав узла)** = строки `BomLine` выбранного `ParentItemId` (таблица lines).
- **Полный состав (все составляющие сборки и подсборки)** = endpoint explosion.

---

## 6) Ограничения и важные примечания (MVP)

1) **Дерево сейчас уникализирует узлы по `ItemId`.**  
   Если один и тот же компонент используется в разных ветках (алмаз/“diamond”), дерево в текущей UI‑модели может отобразить его только в одной ветке.  
   Для корректного отображения “один item в разных местах” нужен ключ узла не только `ItemId`, а, например, `BomLineId` или “path-key”.

2) **“Взрыв” возвращает плоский список строк**, где `Path` помогает различать один и тот же item в разных ветках (если такие ветки есть в данных).

3) **Отсутствующие MDM items**:  
   Для чтения (lines/explosion/tree) допускаются заглушки, чтобы UI не падал на старых/битых данных.  
   Для создания/обновления строки (create/update) — поведение остаётся строгим (проверка существования item) и должно быть согласовано с целевой моделью целостности данных.

---

## 7) Куда это расширять (связка с дальнейшей целевой моделью)

Целевая концепция (из документов модели данных) предполагает:
- ревизии `ItemRevision` / `ProductRevision`,
- BOM на уровне ревизий,
- дальнейшую связку с Technology/Production.

Текущий MVP eBOM — рабочий слой для “структуры/перечней/комплектности” и может быть эволюционирован до ревизионной модели без смены UX-паттерна “Журнал → Карточка → Действия”.

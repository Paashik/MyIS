# Локальная разработка и запуск стенда (backend + frontend)

Этот файл описывает, как развернуть и запустить проект из репозитория [`d:/MyIS`](./): backend (.NET) и frontend (React 18 + Vite), с поддержкой автоматического перезапуска и доступом по IP в локальной сети.

## 1. Предварительные требования

Перед первым запуском убедитесь, что на машине установлено следующее:

- **.NET SDK 8.0+** — скачать можно с официального сайта .NET (`https://dotnet.microsoft.com/`).
- **Node.js 18+** (вместе с npm) — нужен для сборки и запуска frontend (Vite dev server).
- **PostgreSQL** — СУБД для работы backend. Можно использовать локальный экземпляр PostgreSQL или доступный в сети инстанс.
- **Git** — рекомендуется для клонирования репозитория и управления версиями.

После установки желательно перезагрузить терминал/PowerShell или всю систему, чтобы все новые пути (PATH) корректно подхватились.

## 2. Развёртывание проекта «с нуля»

### 2.1. Клонирование репозитория

Откройте `cmd.exe` или PowerShell и выполните:

```cmd
cd /d d:\
git clone <URL_репозитория> MyIS
cd MyIS
```

После этого корень проекта будет доступен по пути `d:\MyIS`.

### 2.2. Установка зависимостей frontend

Перейдите в директорию frontend и установите npm-зависимости:

```cmd
cd /d d:\MyIS\frontend
npm install
```

Эта команда скачает и установит все JS-зависимости, необходимые для сборки и запуска React/Vite frontend.

### 2.3. Применение миграций БД

Перед запуском backend необходимо подготовить базу данных (создать схему и начальные данные). Для этого используется Entity Framework Core и миграции проекта [`backend/src/Core.Infrastructure`](backend/src/Core.Infrastructure/MyIS.Core.Infrastructure.csproj:1).

Из корня репозитория выполните:

```cmd
cd /d d:\MyIS
dotnet ef database update --project backend/src/Core.Infrastructure/MyIS.Core.Infrastructure.csproj --startup-project backend/src/Core.WebApi/MyIS.Core.WebApi.csproj
```

Команда:

- создаст (или обновит) схему БД;
- применит миграции, включая миграцию с созданием администратора по умолчанию `Admin`/`admin`.

Создание администратора реализовано в миграции [`C#.SeedAdminUser`](backend/src/Core.Infrastructure/Migrations/20251210075627_SeedAdminUser.cs:1).

Убедитесь, что строка подключения к PostgreSQL в `appsettings.Development.json` или `appsettings.Local.json` указывает на доступную БД, к которой у вас есть права на создание/изменение схемы.

### 2.4. Открытие портов в Windows Firewall (для доступа из локальной сети)

Если вы планируете открывать доступ к стенду с других устройств в локальной сети (например, с ноутбука, телефона или тестового планшета), необходимо разрешить входящие подключения на порты backend и frontend в брандмауэре Windows.

Откройте консоль от имени администратора и выполните:

```cmd
netsh advfirewall firewall add rule name="MyIS Backend 5000" dir=in action=allow protocol=TCP localport=5000
netsh advfirewall firewall add rule name="MyIS Frontend 5173" dir=in action=allow protocol=TCP localport=5173
```

Эти правила разрешают входящие TCP-подключения на порты `5000` (backend) и `5173` (frontend), что позволяет открывать приложение с других устройств в LAN по IP текущей машины.

## 3. Запуск стенда для разработки

Для удобного одновременного запуска backend и frontend используется скрипт [`dev.cmd`](dev.cmd:1) в корне репозитория.

### 3.1. Запуск dev-стенда

Из корня репозитория выполните:

```cmd
cd /d d:\MyIS
dev.cmd
```

Скрипт откроет два отдельных окна `cmd.exe`:

1. Окно **«MyIS Backend»** — выполняется команда:

   - `dotnet watch run --project backend/src/Core.WebApi/MyIS.Core.WebApi.csproj --urls http://0.0.0.0:5000`

   Backend поднимается на `http://0.0.0.0:5000`, что позволяет принимать запросы как с локальной машины, так и по IP-адресу в локальной сети.

2. Окно **«MyIS Frontend»** — выполняется команда:

   - `npm run dev -- --host 0.0.0.0 --port 5173` из каталога `frontend`.

   Vite dev server поднимается на `http://0.0.0.0:5173` с поддержкой HMR (горячая перезагрузка модулей).

### 3.2. Автоматический перезапуск при изменениях

- При изменениях в backend-проекте (WebApi) `dotnet watch` автоматически пересобирает и перезапускает приложение.
- При изменениях в frontend-коде (React/Vite) Vite автоматически обновляет содержимое страницы в браузере (HMR), без полного ручного перезапуска dev-сервера.

## 4. Как заходить в приложение (локально и по сети)

### 4.1. Доступ с машины разработчика

После запуска скрипта [`dev.cmd`](dev.cmd:1) приложение доступно по следующим адресам:

- **Frontend (UI):** `http://localhost:5173/`
- **Backend API (проверка доступности БД и API):** `http://localhost:5000/api/admin/db-status`

### 4.2. Доступ с другого устройства в локальной сети

Пусть IP-адрес машины разработчика в локальной сети — `192.168.0.10`. Тогда при открытых портах и запущенном dev-стенде:

- **Frontend (UI):** `http://192.168.0.10:5173/`
- **Backend API (при необходимости прямого доступа):** `http://192.168.0.10:5000/api/admin/db-status`

Чтобы узнать IP-адрес, выполните в консоли:

```cmd
ipconfig
```

Обычно используется значение `IPv4-адрес` для активного сетевого адаптера (Ethernet или Wi‑Fi).

## 5. Смена и настройка БД через UI

Если при запуске возникают проблемы с подключением к БД (ошибка в строке подключения, недоступен сервер БД и т.п.) или требуется переключиться на другую базу данных (например, другой инстанс PostgreSQL), это можно сделать через веб-интерфейс.

Основной сценарий:

1. Откройте frontend и перейдите на страницу `/db-setup` (либо вы будете перенаправлены туда автоматически через DbStatusGuard при проблемах с подключением).
2. Введите параметры подключения к PostgreSQL и нажмите кнопку для теста подключения — запрос уходит на эндпоинт `/api/admin/db-config/test`.
3. При успешном тесте сохраните и примените новую строку подключения — вызывается эндпоинт `/api/admin/db-config/apply`.

В режиме разработки логика применения строки подключения:

- записывает (или обновляет) строку подключения в `appsettings.Local.json`;
- применяет необходимые миграции к указанной БД;
- после успешного применения позволяет войти в приложение под учётной записью администратора `Admin`/`admin` уже в новой базе.

Данный функционал реализован в контроллере [`C#.AdminDbController`](backend/src/Core.WebApi/Controllers/AdminDbController.cs:1).

## 6. Отладка и перезапуск

Для диагностики и отладки используйте следующие подходы:

- **Логи backend** — выводятся в окне «MyIS Backend» (там же будет виден стек-трейс при падениях, ошибки БД и т.д.).
- **Логи frontend и сообщения сборки** — видны в окне «MyIS Frontend» и в консоли разработчика браузера (DevTools, вкладка *Console*).
- **Перезапуск процессов**:
  - если backend упал или был остановлен — закройте окно «MyIS Backend» (если ещё открыто) и снова запустите скрипт [`dev.cmd`](dev.cmd:1);
  - если frontend упал или завис — аналогично закройте окно «MyIS Frontend» и снова выполните [`dev.cmd`](dev.cmd:1).

При необходимости можно запускать backend и frontend вручную (без [`dev.cmd`](dev.cmd:1)), используя команды из самого скрипта, однако для повседневной разработки достаточно один раз настроить окружение и затем пользоваться [`dev.cmd`](dev.cmd:1) для быстрого старта обоих процессов.